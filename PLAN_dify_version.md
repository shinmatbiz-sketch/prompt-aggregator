# Prompt Aggregator Dify版 - PRD & 実装プラン

## 1. 要件定義（PRD）

### 1.1 背景と目的

現行の Prompt Aggregator（Next.js版）は、816件のAIプロンプトを検索・閲覧できるWebアプリである。
Dify版では、これを**会話型AIインターフェース（Chatflow）**として再構築し、以下を実現する:

- 自然言語での対話的なプロンプト検索
- LLMによるプロンプト推薦・要約
- ノーコードでの運用・改善
- Webサイトへの埋め込み（チャットウィジェット）

### 1.2 現行版との機能対応マップ

| 現行版（Next.js） | Dify版 | 実現方法 |
|---|---|---|
| Fuse.js テキスト検索 | Knowledge Base セマンティック検索 | RAG（ベクトル検索 + キーワード検索） |
| カテゴリフィルタ | Question Classifier + 条件分岐 | LLMノードでカテゴリ判定 |
| プロンプト一覧表示 | チャット応答でリスト返却 | LLMノードで整形出力 |
| プロンプト詳細表示 | チャット応答で全文返却 | Knowledge Retrieval → LLM |
| コピーボタン | チャット応答からユーザーがコピー | Dify標準のコピー機能 |
| ChatGPTで開く | 応答にリンクを含める | LLMがURL生成して返却 |
| Geminiで開く | 応答にリンクを含める | LLMがURL生成して返却 |
| 無限スクロール | 「もっと見る」の会話継続 | 会話変数で状態管理 |

### 1.3 Dify版の独自メリット

1. **意味理解による検索**: キーワード一致ではなく「〜したい」という意図ベースの検索が可能
2. **対話的な絞り込み**: 「もう少しビジネス向けのものは？」等の追加質問に対応
3. **プロンプト改善提案**: ユーザーの用途に合わせてプロンプトをカスタマイズして提示
4. **多チャネル展開**: Webウィジェット、API、iframe で外部サイトに簡単に埋め込み可能
5. **運用コスト削減**: サーバー不要（Dify Cloud利用時）、ノーコードで更新可能

### 1.4 ターゲットユーザー

- AIプロンプトを業務に活用したい自治体・企業職員
- 目的に合ったプロンプトを自然言語で探したい初心者ユーザー
- 既存Webサイトにプロンプト検索機能を組み込みたい運営者

### 1.5 機能要件

#### F1: プロンプト検索（メイン機能）
- ユーザーの自然言語入力から関連プロンプトを検索
- セマンティック検索（意味理解）とキーワード検索のハイブリッド
- 検索結果は最大5件をカード形式で表示
- 各結果に: ID、タイトル、カテゴリ、本文冒頭、元サイトURL

#### F2: カテゴリ指定検索
- 「プログラミング系のプロンプトを見せて」等のカテゴリ指定に対応
- 8カテゴリの認識と該当プロンプトの絞り込み

#### F3: プロンプト詳細表示
- 「#001の詳細を見せて」等のID指定で全文表示
- プロンプト全文 + ChatGPT/Gemini への直接リンク

#### F4: プロンプト活用支援
- 検索結果のプロンプトをユーザーの具体的な用途に合わせてカスタマイズ提案
- 「このプロンプトを〜の用途に変えて」等のフォローアップ対応

#### F5: 外部埋め込み
- iframe / チャットウィジェットとして外部サイトに設置可能
- Dify API 経由でのプログラマティックアクセス

### 1.6 非機能要件

| 項目 | 要件 |
|------|------|
| 応答速度 | 初回検索3秒以内 |
| 同時接続 | Dify Cloud プランに準拠 |
| データ更新 | Knowledge Base の手動更新（頻度低） |
| LLMモデル | GPT-4o-mini 推奨（コスト/品質バランス） |
| 言語 | 日本語 UI / 日本語応答 |

---

## 2. システム設計

### 2.1 アーキテクチャ概要

```
┌─────────────────────────────────────────────────────┐
│                  Dify Chatflow                       │
│                                                      │
│  [Start] → [Question Classifier] ─┬─→ [検索フロー]  │
│                                    ├─→ [詳細フロー]  │
│                                    ├─→ [カテゴリ]    │
│                                    └─→ [その他]      │
│                                                      │
│  [検索フロー]:                                       │
│    Knowledge Retrieval → LLM (整形・推薦) → [End]    │
│                                                      │
│  [詳細フロー]:                                       │
│    Knowledge Retrieval → LLM (全文表示) → [End]      │
│                                                      │
│  [カテゴリフロー]:                                   │
│    Knowledge Retrieval (filter) → LLM (一覧) → [End] │
│                                                      │
│  [その他]:                                           │
│    LLM (ガイド応答) → [End]                          │
│                                                      │
│  ┌──────────────────┐                                │
│  │  Knowledge Base   │  ← 816件のプロンプトデータ     │
│  │  (セマンティック)  │                                │
│  └──────────────────┘                                │
└─────────────────────────────────────────────────────┘
```

### 2.2 Knowledge Base 設計

#### ドキュメント形式

816件のプロンプトを**個別テキストファイル**として Knowledge Base にアップロード。
1ファイル = 1プロンプト = 1チャンクとし、検索精度を最大化する。

```
# ファイル名: prompt_001.txt

ID: 001
タイトル: 複雑な文章の要点をわかりやすく解説してもらう
カテゴリ: #文章作成・要約, #コミュニケーション支援
URL: https://nanyo-city.jpn.org/prompt/001.html

---

【目的・ねらい】
複雑な内容の文章を、初心者にもわかりやすく解説してもらうための
プロンプトです。

【あなたの役割】
あなたは、複雑な内容をわかりやすく説明する専門のAIアシスタントです。
...（全文）
```

#### チャンク設定

| 設定項目 | 値 |
|----------|-----|
| チャンクモード | General |
| セパレータ | `---`（ファイル単位なので実質1チャンク） |
| チャンクサイズ | 4000 tokens（1プロンプト全体が収まるサイズ） |
| オーバーラップ | 0（1ファイル=1チャンクのため不要） |
| インデックス方式 | ハイブリッド（セマンティック + キーワード） |
| 検索Top-K | 5 |

### 2.3 Chatflow ノード設計

#### ノード1: Start
- 入力変数: `query`（ユーザーの自然言語入力）

#### ノード2: Question Classifier（LLMベース分類）
- 分類先:
  1. **プロンプト検索**: 「〜のプロンプトある？」「〜したい」等
  2. **ID指定詳細**: 「#001を見せて」「001番の詳細」等
  3. **カテゴリ一覧**: 「プログラミング系」「文章作成カテゴリ」等
  4. **その他（挨拶・ヘルプ）**: 「こんにちは」「使い方」等

#### ノード3a: Knowledge Retrieval（検索フロー）
- Knowledge Base: prompt-collection
- 検索クエリ: `{{query}}`
- Top-K: 5
- スコア閾値: 0.5

#### ノード3b: Knowledge Retrieval（ID指定フロー）
- Knowledge Base: prompt-collection
- 検索クエリ: `{{query}}`（IDを含む検索）
- Top-K: 1

#### ノード3c: Knowledge Retrieval（カテゴリフロー）
- Knowledge Base: prompt-collection
- 検索クエリ: カテゴリ名を含む検索
- Top-K: 10

#### ノード4a: LLM - 検索結果整形
```
あなたは「プロンプト検索アシスタント」です。
ユーザーの質問に対して、検索結果から最適なプロンプトを推薦してください。

## ルール
- 検索結果から関連度の高い順に最大5件を表示
- 各プロンプトは以下の形式で表示:

📋 **#{ID} {タイトル}**
🏷️ {カテゴリ}
> {本文の冒頭100文字}...

🔗 [ChatGPTで使う](https://chatgpt.com/?q=...) | [Geminiで使う](https://gemini.google.com/app?q=...)

- 該当がない場合は別のキーワードを提案
- 日本語で応答

## 検索結果
{{#context#}}

## ユーザーの質問
{{query}}
```

#### ノード4b: LLM - 詳細表示
```
ユーザーが指定したプロンプトの全文を表示してください。

## ルール
- プロンプト全文をコードブロックで表示（コピーしやすいように）
- タイトル、カテゴリ、IDを先頭に明示
- ChatGPT/Gemini のリンクを末尾に付与
- 日本語で応答

## 検索結果
{{#context#}}

## ユーザーの質問
{{query}}
```

#### ノード4c: LLM - カテゴリ一覧
```
指定されたカテゴリのプロンプト一覧を表示してください。

## 8カテゴリ
#文章作成・要約, #文書校正・編集, #アイデア創出・企画, #業務改善,
#情報収集・分析, #コミュニケーション支援, #プログラミング, #意識改革・スキルアップ

## ルール
- 該当カテゴリのプロンプトをリスト形式で表示
- 各項目に ID とタイトルを表示
- 10件以上ある場合は代表的な10件を表示し「他にも○件あります」と案内
- 日本語で応答

## 検索結果
{{#context#}}

## ユーザーの質問
{{query}}
```

#### ノード4d: LLM - ガイド応答
```
あなたは「プロンプト検索アシスタント」です。
このサービスの使い方を案内してください。

## できること
1. **プロンプト検索**: 「議事録を要約したい」等、やりたいことを伝えると最適なプロンプトを提案
2. **カテゴリ閲覧**: 「プログラミング系を見せて」等でカテゴリ別一覧を表示
3. **詳細表示**: 「#001の詳細」等でプロンプト全文を表示
4. **カスタマイズ**: 表示されたプロンプトの用途変更や改善の相談

## プロンプト数
全816件、8カテゴリ

## 応答ルール
- フレンドリーな日本語で応答
- 最初の利用時は簡潔に使い方を案内
```

#### ノード5: End（各フローの出力を返却）

---

## 3. 実装プラン

### Phase 1: データ準備（所要: 約30分）

#### Step 1-1: プロンプトデータをDify用テキストファイルに変換

`scripts/export_for_dify.py` を新規作成:
- `data/prompts.json` を読み込み
- 816件それぞれを個別の `.txt` ファイルとして出力
- 出力先: `dify/knowledge_base/prompt_001.txt` ~ `prompt_999.txt`
- フォーマット: メタデータ（ID, タイトル, カテゴリ, URL）+ 区切り線 + 本文全文

#### Step 1-2: 一括アップロード用ZIPの作成
- 816ファイルをZIPにまとめる（Difyは一括20ファイルまでなので、42バッチに分割するか、API経由でアップロード）

### Phase 2: Dify環境構築（所要: 約1時間）

#### Step 2-1: Knowledge Base 作成
- Dify にログイン → Knowledge → Create Knowledge Base
- 名前: `prompt-collection`
- インデックス方式: **High Quality**（Embedding Model使用）
- Embedding Model: `text-embedding-3-small` 推奨
- 検索方式: **Hybrid Search**（セマンティック + キーワード）

#### Step 2-2: ドキュメントアップロード
- Phase 1 で生成したテキストファイルをアップロード
- チャンク設定: General モード、セパレータ `---`
- チャンクサイズ: 4000 tokens
- 全816件のアップロードと埋め込み完了を確認

#### Step 2-3: 検索テスト
- Knowledge Base の「テスト」機能で検索精度を確認
- テストクエリ例:
  - 「議事録を要約したい」→ 関連プロンプトがヒットするか
  - 「Python のコードレビュー」→ プログラミング系がヒットするか
  - 「#001」→ ID指定で正確にヒットするか

### Phase 3: Chatflow 構築（所要: 約1.5時間）

#### Step 3-1: アプリ作成
- Studio → Create App → Chatflow を選択
- 名前: `プロンプト検索アシスタント`

#### Step 3-2: ノード配置
1. **Start** ノード配置
2. **Question Classifier** ノード追加（4分類設定）
3. 各分岐先に **Knowledge Retrieval** ノード追加（計3個）
4. 各 Knowledge Retrieval の後に **LLM** ノード追加（計4個）
5. 各 LLM の出力を **End** ノードに接続

#### Step 3-3: プロンプト設定
- セクション2.3のプロンプトテンプレートを各LLMノードに設定
- モデル: `gpt-4o-mini`（コスト効率重視）
- Temperature: 0.3（事実ベースの応答を優先）

#### Step 3-4: 会話オープナー設定
- 初回メッセージ:
```
👋 プロンプト検索アシスタントへようこそ！
南陽市が公開している816件のAIプロンプトから、
あなたに最適なプロンプトをお探しします。

💡 使い方:
• やりたいことを入力 → 「メール文面を作りたい」
• カテゴリで探す → 「プログラミング系を見せて」
• ID指定 → 「#001の詳細を見せて」
```

- サジェスト質問:
  - 「文章を要約するプロンプトを探して」
  - 「プログラミング系のプロンプト一覧」
  - 「業務改善に使えるプロンプトは？」

### Phase 4: テストと公開（所要: 約30分）

#### Step 4-1: 動作テスト
- 検索精度テスト（10パターン以上）
- ID指定テスト
- カテゴリ絞り込みテスト
- 会話継続テスト（フォローアップ質問）
- エッジケース（存在しないID、曖昧な質問）

#### Step 4-2: 公開設定
- アプリを公開
- Web App URL 取得
- 埋め込みコード（iframe / チャットウィジェット）生成

#### Step 4-3: DSL エクスポート
- 完成した Chatflow を YAML DSL としてエクスポート
- `dify/prompt-aggregator-chatflow.yml` として保存
- バージョン管理に含める

### Phase 5: オプション - 外部連携

#### Step 5-1: API連携（必要に応じて）
- Dify API Key 発行
- 外部アプリからの呼び出しテスト

#### Step 5-2: 既存Next.js版との連携（必要に応じて）
- Next.js版にDifyチャットウィジェットを埋め込み
- 検索UIとAI対話の両方を提供するハイブリッド構成

---

## 4. 成果物一覧

| # | ファイル/成果物 | 説明 |
|---|----------------|------|
| 1 | `scripts/export_for_dify.py` | prompts.json → Dify用テキストファイル変換スクリプト |
| 2 | `dify/knowledge_base/*.txt` | 816件の個別プロンプトファイル（Knowledge Base用） |
| 3 | `dify/knowledge_base.zip` | アップロード用ZIP |
| 4 | `dify/prompt-aggregator-chatflow.yml` | Chatflow DSL（エクスポート） |
| 5 | `dify/README.md` | Dify版セットアップ手順書 |

---

## 5. 前提条件・制約

### 必要なアカウント/環境
- **Dify Cloud アカウント**（https://cloud.dify.ai）またはセルフホスト Dify インスタンス
- **LLM API Key**: OpenAI（GPT-4o-mini）または他の対応モデル
- **Embedding Model**: text-embedding-3-small（OpenAI）推奨

### 制約事項
- Dify Cloud 無料プランでは Knowledge Base のドキュメント数やメッセージ数に制限あり
- 816ファイルの一括アップロードは20ファイル/バッチの制限あり（API利用で回避可能）
- ChatGPT/Gemini のリンクはチャット応答内のテキストリンクとなる（ボタンUIは不可）
- リアルタイムのクライアントサイド検索（現行版）とは異なり、LLM呼び出しのレイテンシが発生

### コスト見積もり（Dify Cloud + OpenAI）
| 項目 | 概算 |
|------|------|
| Embedding（初回） | 816件 × ~500 tokens ≈ 400K tokens → ~$0.01 |
| 検索1回あたり | GPT-4o-mini ~500 tokens → ~$0.0003 |
| 月1000回利用時 | ~$0.30/月 |

---

## 6. リスクと対策

| リスク | 影響 | 対策 |
|--------|------|------|
| Knowledge Base の検索精度が不十分 | 関連プロンプトがヒットしない | ハイブリッド検索 + Top-K調整 + Reranking有効化 |
| 長いプロンプトがチャンク分割される | 全文が検索結果に含まれない | 1ファイル=1チャンク設計で回避 |
| LLMの応答がハルシネーション | 存在しないプロンプトを返す | システムプロンプトで「検索結果にないものは返さない」を厳守 |
| 20ファイル/バッチの制限 | アップロードに手間 | Dify API経由での自動アップロードスクリプト作成 |
| 日本語の検索精度 | 英語に比べ精度が低い可能性 | 多言語対応の Embedding モデル選定、テストで確認 |

---

## 7. 参考リソース

- [Dify 公式ドキュメント](https://docs.dify.ai/)
- [Dify Knowledge Base](https://docs.dify.ai/en/use-dify/knowledge/readme)
- [Dify Workflow 紹介](https://dify.ai/blog/dify-ai-workflow)
- [Dify Chatflow 埋め込み](https://docs.dify.ai/en/use-dify/publish/webapp/embedding-in-websites)
- [Dify DSL エクスポート](https://docs.dify.ai/en/use-dify/workspace/app-management)

---

*Plan created: 2026-02-15*
